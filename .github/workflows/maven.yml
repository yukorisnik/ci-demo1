name: Java CI with Maven (Optimized)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4


      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # --- Steg 3: Cacha Chrome och Selenium ---
      - name: Cache Chrome binaries
        uses: actions/cache@v3             # Cacha filer mellan körningar
        with:
          path: |                          # Vilka mappar som ska sparas
            ~/.cache/chromium             
            ~/.cache/selenium
          key: ${{ runner.os }}-chrome-${{ hashFiles('**/pom.xml') }}
          # Unikt cache-key baserat på OS + pom.xml-hash
          restore-keys: |
            ${{ runner.os }}-chrome-      
      

      - name: Ensure Chrome & Chromedriver
        run: |                             # Kör kommandon i bash
          if ! command -v google-chrome && ! command -v chromium-browser; then
            echo "Installing Chrome..."   
            sudo apt-get update
            sudo apt-get install -y chromium-browser
          fi
          if ! command -v chromedriver; then
            echo "Installing Chromedriver..."  
            sudo apt-get install -y chromium-chromedriver
          fi
          google-chrome --version || chromium-browser --version  # Visa version
          which chromedriver             
      

      - name: Build and test
        env:
          CHROME_OPTS: "--headless --no-sandbox --disable-dev-shm-usage"

        run: |
          echo "Running Selenium and unit tests..."
          mvn -B clean test \
            -Dwebdriver.chrome.driver=$(which chromedriver)
          # Kör Maven i batch-läge (-B), cleans build, och startar tester
          # Anger var Chromedriver finns (följer Chrome-versionen i runnern)
      

      - name: Upload test reports
        if: always()                      # Kör även om tidigare steg misslyckas
        uses: actions/upload-artifact@v4  # Ladda upp filer som artefakter
        with:
          name: surefire-reports          # Namn på artefakten (syns i Actions)
          path: target/surefire-reports/  # Mappen där JUnit-rapporterna sparas
